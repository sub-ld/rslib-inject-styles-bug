# rslib `module.id` Bug Report - Comprehensive Analysis

## Summary

**rslib v0.14.0** generates CommonJS `module.id` references in ESM output when using `injectStyles: true` with CSS containing `@font-face` declarations, causing runtime errors in browsers.

## üéØ Root Cause (Discovered)

The issue occurs when **ALL** these conditions are met:

1. ‚úÖ **`injectStyles: true`** in rslib config
2. ‚úÖ **`format: "esm"`** (ESM output format)
3. ‚úÖ **`@font-face` declarations** in imported CSS files
4. ‚úÖ **Any export** from the module that imports the CSS

**Key Finding**: It's not React-specific - any export from a module importing CSS with `@font-face` triggers the issue.

## Environment

- **@rslib/core**: 0.14.0
- **@rsbuild/core**: 1.5.12
- **@rsbuild/plugin-react**: 1.4.1
- **Node.js**: Latest
- **Browser**: Any modern browser

## üìã Minimal Reproduction Case

**File structure:**

```
src/
‚îú‚îÄ‚îÄ index.ts          # Entry point with CSS import + any export
‚îú‚îÄ‚îÄ globals.css       # Contains @font-face declaration
```

**`src/globals.css`:**

```css
/* Minimal reproduction: @font-face triggers module.id issue */
@font-face {
  font-family: "TestFont";
  src: url("data:font/woff2;base64,") format("woff2");
}
```

**`src/index.ts`:**

```typescript
import "./globals.css";
export const foo = "bar"; // ANY export triggers the issue
```

**`rslib.config.ts`:**

```typescript
export default defineConfig({
  lib: [{ bundle: true, dts: true, format: "esm" }],
  output: { injectStyles: true, target: "web" },
  plugins: [pluginReact()],
});
```

## üêõ Problematic Code Generated

The built ESM library contains:

```javascript
___CSS_LOADER_EXPORT___.push([
  module.id, // ‚Üê CommonJS artifact in ESM bundle
  `@font-face { font-family: "TestFont"; ... }`,
]);
```

## üí• Runtime Error

```
Uncaught ReferenceError: module is not defined
    at http://localhost:4173/assets/index-[hash].js:321:2408
```

**When it occurs**: Only when consuming the library in production builds (not dev mode).

## üß™ Test Matrix

| CSS Import    | Component Export | `module.id` Count | Runtime Result                |
| ------------- | ---------------- | ----------------- | ----------------------------- |
| ‚ùå None       | ‚úÖ Yes           | 0                 | ‚úÖ Works                      |
| ‚úÖ @font-face | ‚ùå None          | 1                 | ‚ö†Ô∏è Has module.id but may work |
| ‚úÖ @font-face | ‚úÖ Yes           | 1                 | ‚ùå **Runtime Error**          |

## üîç Technical Analysis

### Why This is an rslib Issue (Not Vite)

1. **Problem occurs during rslib build** - `module.id` references generated by rslib
2. **ESM/CommonJS mismatch** - rslib generates CommonJS code in ESM output
3. **CSS injection mechanism** - `injectStyles: true` uses webpack/rspack loaders that emit CommonJS-style code
4. **Vite correctly fails** - Vite properly rejects `module.id` in ESM context

### Evidence

**With `injectStyles: true`:**

```
File (esm)      Size      Gzip
dist/index.js   14.9 kB   3.3 kB  // CSS injected, contains module.id
```

**With `injectStyles: false`:**

```
File (esm)       Size      Gzip
dist/index.js    0.03 kB   0.05 kB
dist/index.css   0.09 kB   0.10 kB  // Separate CSS file, no module.id
```

## üö® Impact

- **Blocks ESM adoption** for libraries using `@font-face` with `injectStyles: true`
- **Forces workarounds** like `injectStyles: false` or separate CSS handling
- **Affects any library** importing CSS with font declarations

## ‚úÖ Workarounds

### Option 1: Disable Style Injection (Recommended)

```typescript
export default defineConfig({
  output: { injectStyles: false }, // Generate separate CSS file
});
```

### Option 2: Use CSS-in-JS

```typescript
import styled, { createGlobalStyle } from "styled-components";
const GlobalStyles = createGlobalStyle`@font-face { ... }`;
```

### Option 3: Consumer-Side CSS Import

```typescript
// Library: Don't import CSS
export const foo = "bar";

// Consumer: Import CSS separately
import "your-library/dist/index.css";
import { foo } from "your-library";
```

## üéØ Expected Behavior

ESM libraries with `injectStyles: true` should:

1. **Not generate** CommonJS artifacts like `module.id`
2. **Properly transform** CSS loader output for ESM compatibility
3. **Work seamlessly** with `@font-face` declarations

## ‚úÖ Reproduction Status

**Confirmed reproducible** with minimal setup:

- `grep "module.id" dist/index.js` returns matches
- Consumer app fails in production with `ReferenceError: module is not defined`
- Issue isolated to `@font-face` + `injectStyles: true` + ESM format combination

## üìù Recommendation

This is a **critical bug** in rslib's CSS injection mechanism that should be prioritized for ESM compatibility.
